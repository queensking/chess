!function(e,r){"use strict";class t{constructor(){}static init(){if(!t.lookup){t.lookup=new Uint8Array(256);for(var e=0;e<t.chars.length;e++)t.lookup[t.chars.charCodeAt(e)]=e}}static isBase64String(e){return t.reg.test(e)}static encode(e){var r,a=new Uint8Array(e),s=a.length,n="";for(r=0;r<s;r+=3)n+=t.chars[a[r]>>2],n+=t.chars[(3&a[r])<<4|a[r+1]>>4],n+=t.chars[(15&a[r+1])<<2|a[r+2]>>6],n+=t.chars[63&a[r+2]];return s%3==2?n=n.substring(0,n.length-1)+"=":s%3==1&&(n=n.substring(0,n.length-2)+"=="),n}static decode(e){t.init();var r,a,s,n,o,i=.75*e.length,l=e.length,h=0;"="===e[e.length-1]&&(i--,"="===e[e.length-2]&&i--);var f=new ArrayBuffer(i),c=new Uint8Array(f);for(r=0;r<l;r+=4)a=t.lookup[e.charCodeAt(r)],s=t.lookup[e.charCodeAt(r+1)],n=t.lookup[e.charCodeAt(r+2)],o=t.lookup[e.charCodeAt(r+3)],c[h++]=a<<2|s>>4,c[h++]=(15&s)<<4|n>>2,c[h++]=(3&n)<<6|63&o;return f}}var a,s,n;t.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,t.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,t.lookup=null,(a=e.GLTFComponentType||(e.GLTFComponentType={}))[a.BYTE=5120]="BYTE",a[a.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",a[a.SHORT=5122]="SHORT",a[a.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",a[a.UNSIGNED_INT=5125]="UNSIGNED_INT",a[a.FLOAT=5126]="FLOAT",(s=e.GLTFAccessorType||(e.GLTFAccessorType={})).SCALAR="SCALAR",s.VEC2="VEC2",s.VEC3="VEC3",s.VEC4="VEC4",s.MAT2="MAT2",s.MAT3="MAT3",s.MAT4="MAT4",(n=e.GLTFRenderMode||(e.GLTFRenderMode={}))[n.POINTS=0]="POINTS",n[n.LINES=1]="LINES",n[n.LINE_LOOP=2]="LINE_LOOP",n[n.LINE_STRIP=3]="LINE_STRIP",n[n.TRIANGLES=4]="TRIANGLES",n[n.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",n[n.TRIANGLE_FAN=6]="TRIANGLE_FAN";class o{constructor(){this.extraFunc={meshExtras:void 0,materialExtras:void 0},this.gltfBuffers=[],this.gltfImages=[],o.defaultMatrial||(o.defaultMatrial=new r.PBRStandardMaterial)}clearData(){this._gltf=null,this.gltfRoot=null,this._spriteNodes=[],this.gltfBuffers=[],this.gltfImages=[]}destroy(){this._gltf=null,this._onLoaded=null,this.gltfRoot=null,this._spriteNodes=null,this.gltfBuffers=null,this.gltfImages=null}loadGLTF(e,a){this._onLoaded=a,e instanceof Array||(e=[e]);var s=[],n=[];e.forEach(e=>{if(!e)return!0;var t;t="string"==typeof e?e:e.url,"gltf"==r.Utils.getFileExtension(t)?s.push(e):n.push(e)});var i=!0,l=s.length,h=0,f=new Array(l).fill(!1);s.forEach((e,a)=>{var s=r.URL.getPath(e.url),c=r.Handler.create(this,(function(e,c=null){h++;var u={urlItem:e,base:s,loadedCount:h,itemCount:l,loadedFlags:f},d=[];c||(i=!1);var g=r.Loader.getRes(u.urlItem.url);if(g.buffers&&g.buffers.forEach((e,a)=>{t.isBase64String(e.uri)||d.push({url:s+e.uri,type:r.Loader.BUFFER})}),g.images&&g.images.forEach(e=>{t.isBase64String(e.uri)?d.push({url:e.uri,type:o.GLTFIMAGETYPE}):d.push({url:s+e.uri,type:o.GLTFIMAGETYPE})}),0==a&&d.push(...n),d.length){var A=r.Handler.create(this,(function(e,r){r||(i=!1),this.collectionLoadItems(u,i,r)}),[e]);r.Laya.loader.create(d,A)}else this.collectionLoadItems(u,i,!0)}),[e]);r.Laya.loader.create([e],c)}),0==s.length&&r.Laya.loader.create(n,a)}collectionLoadItems(e,r,t){this.onLoaded(e,r,t)}onLoaded(e,a,s){var n=e.urlItem,i=e.loadedCount,l=(e.itemCount,e.base),h=e.loadedFlags;h[i-1]=!0;var f=!0;if(h.forEach(e=>{f=f&&e}),s)if(o.loadedMap[r.URL.formatURL(n.url)]);else{if(this._gltf=r.Loader.getRes(n.url),"2.0"!==this._gltf.asset.version)console.warn("only support gltf 2.0!"),s=!1;else{this._gltf.buffers&&this._gltf.buffers.forEach((e,a)=>{if(t.isBase64String(e.uri)){var s=e.uri.replace(t.reghead,"");this.gltfBuffers[a]=t.decode(s)}else this.gltfBuffers[a]=r.Loader.getRes(l+e.uri)}),this._gltf.images&&this._gltf.images.forEach((e,a)=>{var s;s=t.isBase64String(e.uri)?e.uri:l+e.uri,this.gltfImages[a]=r.Loader.getRes(s)});var c=r.URL.getFileName(n.url);this.gltfParse(c),o.loadedMap[r.URL.formatURL(n.url)]=this.gltfRoot}}else console.warn("[error]Failed to parse:",n.url);this.clearData(),e=null,f&&this._onLoaded&&this._onLoaded.runWith([s&&a])}static getRes(e){return o.loadedMap[r.URL.formatURL(e)]}static clearRes(e){var t=r.URL.formatURL(e);o.loadedMap[t]&&delete o.loadedMap[t],r.Loader.clearRes(e)}gltfParse(e){if(this._gltf.nodes){var t=this._gltf.nodes,a=new Array(t.length);this._spriteNodes=a,t.forEach((e,r)=>{this.gltfParseNode(e,a,r)})}if(this._gltf.scenes){var s=this._gltf.scene||0,n=this._gltf.scenes[s],i=e;this.gltfRoot=new r.Sprite3D(i),this.gltfParseScene(n,this.gltfRoot)}(this._spriteNodes.forEach(e=>{e instanceof r.SkinnedMeshSprite3D&&o.calSkinnedSpriteLocalBounds(e)}),this._gltf.animations)&&this._gltf.animations.forEach((e,r)=>{this.gltfParseAniamtion(e,r)})}gltfParseScene(e,r){var t=e.nodes,a=this._gltf.nodes;(t||a)&&t.forEach(e=>{var t=a[e],s=this._spriteNodes[e];r.addChild(s),this.buildHierarchy(t,s,1)})}gltfParseAniamtion(e,t){var a=e.channels,s=e.samplers,n=this.getAnimationRoot(a),o=0,i=new Array(a.length);a.forEach((e,r)=>{var t=i[r]={},a=e.target,l=this._gltf.nodes[a.node],h=this.gltfParseNode(l,this._spriteNodes,a.node),f=s[e.sampler],c=this._gltf.accessors[f.input],u=this._gltf.accessors[f.output],d=this.getAccessorBuffer(c),g=this.getAccessorBuffer(u);switch(t.paths=this.getAniamtionPath(n,h),t.propertyOwner="transform",t.propertyLength=1,t.propertise=[],a.path){case"translation":t.propertise.push("localPosition"),t.type=1;break;case"rotation":t.propertise.push("localRotation"),t.type=2;break;case"scale":t.propertise.push("localScale"),t.type=3}t.timeArray=new Float32Array(d),t.valueArray=new Float32Array(g),t.duration=t.timeArray[t.timeArray.length-1],o=Math.max(o,t.duration)});var l=n.addComponent(r.Animator),h=e.name?e.name:"Aniamtor"+t,f=new r.AnimatorControllerLayer(h),c=new r.AnimationClip;c.name="clip name",c._duration=o,c.islooping=!0,c._frameRate=30;var u=i.length,d=c._nodes;d.count=u;for(var g=c._nodesMap={},A=c._nodesDic={},p=0;p<u;p++){var m=new r.KeyframeNode,v=i[p];d.setNodeByIndex(p,m),m._indexInList=p;var y=m.type=v.type,T=v.paths.length;m._setOwnerPathCount(T);for(var E=v.paths,_=0;_<T;_++)m._setOwnerPathByIndex(_,E[_]);var I=m._joinOwnerPath("/"),L=g[I];L||(g[I]=L=[]),L.push(m),m.propertyOwner=v.propertyOwner;var b=v.propertyLength;m._setPropertyCount(b);for(_=0;_<b;_++)m._setPropertyByIndex(_,v.propertise[_]);var M=I+"."+m.propertyOwner+"."+m._joinProperty(".");A[M]=M,m.fullPath=M;var x=v.timeArray.length;for(_=0;_<x;_++)switch(y){case 0:break;case 1:case 3:case 4:var N=new r.Vector3Keyframe;m._setKeyframeByIndex(_,N);N.time=v.timeArray[_];var S=N.inTangent,w=N.outTangent,B=N.value;S.setValue(0,0,0),w.setValue(0,0,0),B.setValue(v.valueArray[3*_],v.valueArray[3*_+1],v.valueArray[3*_+2]);break;case 2:var R=new r.QuaternionKeyframe;m._setKeyframeByIndex(_,R);R.time=v.timeArray[_];var C=R.inTangent,P=R.outTangent,F=R.value;C.setValue(0,0,0,0),P.setValue(0,0,0,0),F.x=v.valueArray[4*_],F.y=v.valueArray[4*_+1],F.z=v.valueArray[4*_+2],F.w=v.valueArray[4*_+3]}}var O=new r.AnimatorState;O.name="state name",O.clip=c,f.addState(O),f.defaultState=O,f.playOnWake=!0,l.addControllerLayer(f),f.defaultWeight=1}getAnimationRoot(e){var r=Number.MAX_VALUE,t=[];return e.forEach((e,a)=>{var s=e.target,n=this._gltf.nodes[s.node];if(n.hierarchyDepth<r){r=n.hierarchyDepth;var o=this.gltfParseNode(n,this._spriteNodes,s.node);t=[o]}else if(n.hierarchyDepth==r){o=this.gltfParseNode(n,this._spriteNodes,s.node);t.push(o)}}),1==t.length?t[0]:this.gltfRoot}getAniamtionPath(e,t){var a=[];if(e==t)return a;for(var s=t;s.parent!=e||s.parent instanceof r.Scene3D;)s=s.parent,a.push(s.name);return(a=a.reverse()).push(t.name),a}buildHierarchy(e,r,t){void 0!==e.children&&e.children.forEach(e=>{var a=this._gltf.nodes[e];a.hierarchyDepth=t;var s=this._spriteNodes[e];r.addChild(s),this.buildHierarchy(a,s,t+1)})}gltfParseNode(e,t,a){if(t[a])return t[a];if(e){var s,n=e.name;if(void 0!==e.mesh&&void 0!==e.skin){var o=this._gltf.skins[e.skin],i=this.gltfParseSkins(o),l=[],h=this.gltfParseMesh(this._gltf.meshes[e.mesh],l,i);this.meshApplySkinData(h,i);var f=(s=new r.SkinnedMeshSprite3D(h,n)).skinnedMeshRenderer,c=i.rootBone,u=i.bones;f.rootBone=c,f.bones.push(...u),f.sharedMaterials=l}else if(void 0!==e.mesh){l=[],h=this.gltfParseMesh(this._gltf.meshes[e.mesh],l);(s=new r.MeshSprite3D(h,n)).meshRenderer.sharedMaterials=l}else s=new r.Sprite3D(n);if(e.matrix){var d=s.transform.localMatrix;d.elements.set(e.matrix),s.transform.localMatrix=d}else{var g=s.transform.localPosition,A=s.transform.localRotation,p=s.transform.localScale;e.translation&&g.fromArray(e.translation),e.rotation&&A.fromArray(e.rotation),e.scale&&p.fromArray(e.scale),s.transform.localPosition=g,s.transform.localRotation=A,s.transform.localScale=p}return t[a]=s,s}}gltfParseSkins(e){var r=this._gltf.accessors[e.inverseBindMatrices],t=this.getAccessorBuffer(r),a=e.skeleton,s=this._gltf.nodes[a],n=this.gltfParseNode(s,this._spriteNodes,a),o=e.joints,i=o.length,l=new Array(i),h=[];o.forEach((e,r)=>{var t=this._gltf.nodes[e];l[r]=t.name,h[r]=this.gltfParseNode(t,this._spriteNodes,e)});var f={};return f.boneNames=l,f.bones=h,f.boneCount=f.bones.length,f.rootBone=n||h[0],f.inverseBindMatricesArray=t,f}meshApplySkinData(e,t){e._boneNames=t.boneNames,e._inverseBindPoses=[],e._inverseBindPosesBuffer=t.inverseBindMatricesArray.buffer,e._setInstanceBuffer(r.Mesh.MESH_INSTANCEBUFFER_TYPE_NORMAL);for(var a=t.boneNames.length,s=0;s<a;s++){var n=16*s,o=t.inverseBindMatricesArray.slice(n,n+16);e._inverseBindPoses[s]=new r.Matrix4x4(o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7],o[8],o[9],o[10],o[11],o[12],o[13],o[14],o[15],o)}for(var i=e.subMeshCount,l=0;l<i;l++){var h=e.getSubMesh(l),f=e._skinnedMatrixCaches;f.length=e._inverseBindPoses.length;for(var c=h._subIndexBufferStart.length,u=0;u<c;u++)for(var d=h._boneIndicesList[u],g=0;g<d.length;g++){var A=d[g];f[A]||(f[A]=new r.skinnedMatrixCache(l,u,g))}}for(var p=0;p<f.length;p++)f[p]||(f[p]=new r.skinnedMatrixCache(0,0,0))}static calSkinnedSpriteLocalBounds(e){var t=e.skinnedMeshRenderer,a=e.meshFilter.sharedMesh,s=t.rootBone.transform.worldMatrix,n=new r.Matrix4x4;s.invert(n);var o=a.getIndices(),i=[],l=[],h=[];a.getPositions(i),a.getBoneIndices(l),a.getBoneWeights(h);var f=[];a._subMeshes.forEach((e,t)=>{e._boneIndicesList.forEach((t,a)=>{var s=e._subIndexBufferStart[a],n=e._subIndexBufferCount[a]+s;for(let e=s;e<n;e++){var i=o[e],h=l[i],c=t[h.x],u=t[h.y],d=t[h.z],g=t[h.w];f[i]=new r.Vector4(c,u,d,g)}})});var c=a._inverseBindPoses,u=t.bones,d=[],g=new r.Matrix4x4;u.forEach((e,t)=>{d[t]=new r.Matrix4x4,r.Matrix4x4.multiply(n,e.transform.worldMatrix,g),r.Matrix4x4.multiply(g,c[t],d[t])});var A=new r.Matrix4x4,p=new r.Vector3,m=new r.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),v=new r.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);i.forEach((e,t)=>{var a=f[t],s=h[t];for(let e=0;e<16;e++)A.elements[e]=d[a.x].elements[e]*s.x,A.elements[e]+=d[a.y].elements[e]*s.y,A.elements[e]+=d[a.z].elements[e]*s.z,A.elements[e]+=d[a.w].elements[e]*s.w;r.Vector3.transformV3ToV3(e,A,p),r.Vector3.min(m,p,m),r.Vector3.max(v,p,v)}),i=null,l=h=f=null,o=null,d=null,t.localBounds.setMin(m),t.localBounds.setMax(v)}gltfParseMesh(e,r,t){e.extras&&this.extraFunc&&this.extraFunc.meshExtras&&this.extraFunc.meshExtras(e)();var a=e.primitives,s=new Array(a.length),n=0,o=0,i=e.weights;a.forEach((r,a)=>{var l,h={};if(h.renderMode=r.mode,void 0!==r.indices)l=this.gltfPrimitiveIndexBuffer(r);else{l=new Uint32Array(h.vertexCount);for(var f=0;f<h.vertexCount;f++)l[f]=f}h.indexArray=l.reverse();var c=r.targets,u=c?c.length:0,d=new Array(u),g=e.extras?e.extras.targetNames:null;c&&c.forEach((e,r)=>{d[r]=new Map;g&&g[r];for(const n in e){var t=this._gltf.accessors[e[n]],a=this.getAccessorBuffer(t),s=new Float32Array(a);d[r].set(n,s)}}),this.gltfPrimitiveSubMesh(h,r,d,i,t),s[a]=h,d=null,void 0!==r.material&&(h.gltfMaterial=this._gltf.materials[r.material]),n+=h.vertexArray.length,o+=h.indexArray.length});var l=this.generatMesh(s,n,o,e.name);return this.getMaterials(s,r),l}applyMorphtargets(e,r,t){r.forEach((r,a)=>{r.forEach((r,s)=>{if(e.has(s))for(var n=e.get(s),o=t[a],i=0,l=n.length;i<l;i++)n[i]+=o*r[i]})})}getMaterials(e,r){r.length=e.length,e.forEach((e,t)=>{null==e.gltfMaterial?r[t]=o.defaultMatrial:r[t]=this.gltfParseMaterial(e.gltfMaterial)})}gltfParseMaterial(e){var t,a=t=o.defaultMatrial.clone();for(const t in e)switch(t){case"pbrMetallicRoughness":this.gltfParsePbrMetallicRoughness(e.pbrMetallicRoughness,a);break;case"normalTexture":var s=e[t],n=this.gltfGetTextureWithInfo(s);a.normalTexture=n,void 0!==s.scale&&(a.normalTextureScale=s.scale);break;case"occlusionTexture":s=e[t];var i=this.gltfGetTextureWithInfo(s);a.occlusionTexture=i,void 0!==s.strength&&(a.occlusionTextureStrength=s.strength);break;case"emissiveTexture":s=e[t];var l=this.gltfGetTextureWithInfo(s);a.emissionTexture=l;break;case"emissiveFactor":var h=a.emissionColor;h.fromArray(e[t]),a.emissionColor=h;break;case"alphaMode":var f;switch(e.alphaMode){case"OPAQUE":f=r.PBRRenderMode.Opaque;break;case"MASK":f=r.PBRRenderMode.Cutout;break;case"BLEND":f=r.PBRRenderMode.Transparent}a.renderMode=f;break;case"alphaCutoff":a.alphaTestValue=e.alphaCutoff;break;case"doubleSided":e.doubleSided&&(a.cull=r.RenderState.CULL_NONE)}return t.name=e.name,e.extras&&this.extraFunc&&this.extraFunc.materialExtras&&this.extraFunc.materialExtras(this,e,t)(),t}gltfParsePbrMetallicRoughness(e,r){for(const l in e)switch(l){case"baseColorFactor":var t=r.albedoColor;t.fromArray(e.baseColorFactor),r.albedoColor=t;break;case"baseColorTexture":var a=e.baseColorTexture,s=this.gltfGetTextureWithInfo(a);r.albedoTexture=s;break;case"metallicFactor":var n=e.metallicFactor;r.metallic=n;break;case"roughnessFactor":var o=e.roughnessFactor;r.smoothness=1-o;break;case"metallicRoughnessTexture":a=e.metallicRoughnessTexture;var i=this.gltfGetTextureWithInfo(a);r.metallicGlossTexture=i}}gltfGetTextureWithInfo(e){if(!e)return null;var r=this._gltf.textures[e.index];return this.gltfParseTexture(r)}gltfParseTexture(e){var t=this.gltfImages[e.source];if(!t){var a=this._gltf.images[e.source];t=this.gltfParseImageFromBufferView(a)}if(null!=e.sampler)var s=this._gltf.samplers[e.sampler];else s={};var n=s.magFilter,i=s.minFilter,l=t.width,h=t.height,f=this.needMipMap(n,i),c=this.getFilterMode(n,i,f),u=new r.Texture2D(l,h,r.TextureFormat.R8G8B8A8,f);u.loadImageSource(t),u.filterMode=c;var d=this.getWarpMode(s.wrapT),g=this.getWarpMode(s.wrapS);return u.wrapModeV=d,u.wrapModeU=g,o.textureMap[t.src]=u,u}needMipMap(e,r){return!0}getFilterMode(e,t,a){var s=r.LayaGL.instance;return e==s.NEAREST?r.FilterMode.Point:e==s.LINEAR?a&&t==s.LINEAR_MIPMAP_LINEAR?r.FilterMode.Trilinear:r.FilterMode.Bilinear:r.FilterMode.Point}getWarpMode(e){var t=r.LayaGL.instance;switch(e){case t.REPEAT:case t.CLAMP_TO_EDGE:return r.WarpMode.Repeat;case t.MIRRORED_REPEAT:default:return r.WarpMode.Repeat}}gltfParseImageFromBufferView(e){void 0!==e.bufferView&&(e.mimeType,console.warn("warning: don't support bufferView image!"))}gltfPrimitiveSubMesh(e,r,t,a,s){var n=r.attributes,i=new Map,l=o.gltfAttributeOrder,h=o.layaAttributeOrder,f="",c=!1,u=0,d=0;l.forEach((e,r)=>{if(e in n){var t=this._gltf.accessors[n[e]];u=t.count;var a=this.getAccessorBuffer(t),s=new Float32Array(a),o=s.length;"JOINTS_0"==e&&(o/=4),d+=o;var l=h[r];i.set(l,s),c?f+=",":c=!0,f+=l}}),this.applyMorphtargets(i,t,a);var g=e.boneIndicesList=new Array,A=e.subIndexStartArray=[],p=e.subIndexCountArray=[];if(i.has("BLENDINDICES")){if(s.boneCount<=o.maxSubBoneCount){A[0]=0,p[0]=e.indexArray.length,g[0]=new Uint16Array(s.boneCount);for(var m=0;m<s.boneCount;m++)g[0][m]=m}else this.splitSubMeshByBonesCount(i,e.indexArray,s,g,A,p),u=i.get("BLENDINDICES").length/4,d=0,i.forEach((e,r)=>{var t=e.length;"BLENDINDICES"==r&&(t/=4),d+=t});var v=new Uint8Array(i.get("BLENDINDICES"));i.set("BLENDINDICES",new Float32Array(v.buffer))}else A[0]=0,p[0]=e.indexArray.length;var y=this.mergeOnePrimitiveArray(d,u,i);return i.clear(),e.vertexArray=y,e.vertexCount=u,e.vertexDeclarationStr=f,e}gltfTempParseVB(e,r){var t=e.indexArray,a=t.length,s=new Uint32Array(a);for(let e=0;e<t.length;e++)s[e]=e;e.indexArray=s,r.forEach((e,s)=>{let n=0;switch(s){case"POSITION":case"NORMAL":n=3;break;case"COLOR":n=4;break;case"UV":case"UV1":n=2;break;case"BLENDWEIGHT":case"BLENDINDICES":case"TANGENT":n=4}let o=e,i=new Float32Array(n*a);for(let e=0;e<a;e++){let r=e*n,a=t[e]*n;for(let e=0;e<n;e++)i[r+e]=o[a+e]}r.set(s,i),o=null})}splitSubMeshByBonesCount(e,r,t,a,s,n){let i=o.maxSubBoneCount,l=0,h=new Set,f=e.get("BLENDINDICES"),c=f.length/4,u=new Float32Array(f.length).fill(9999),d=new Array(c).fill(!1);for(let e=0,t=r.length;e<t;e+=3){let o=new Set;for(let t=e;t<e+3;t++){let e=4*r[t];for(let r=0;r<4;r++)o.add(f[e+r])}let c=new Set([...h,...o]);if(c.size>i){let r=e-l;s.push(l),n.push(r);let t=Array.from(h);a.push(new Uint16Array(t)),l=e,h=new Set(o)}else h=c;if(e==t-3){let r=e-l+3;s.push(l),n.push(r),l=e;let t=Array.from(h);a.push(new Uint16Array(t))}}let g=a.length,A=(n.length==s.length&&s.length,new Map);e.forEach((e,r)=>{let t=new Array;A.set(r,t)});var p=c-1;for(let t=0;t<g;t++){let o=s[t],i=n[t],l=a[t],h=new Array(c).fill(!1),g=new Map;for(let t=0;t<i;t++){let a=r[t+o],s=4*a;for(let e=s;e<s+4;e++){let r=f[e],t=l.indexOf(r);t=-1==t?0:t,d[a]&&!h[a]?A.get("BLENDINDICES").push(t):d[a]&&h[a]||(u[e]=t)}d[a]||h[a]?!d[a]&&h[a]?r[t+o]=g.get(a):d[a]&&!h[a]?(h[a]=!0,p++,g.set(a,p),r[t+o]=p,A.forEach((r,t)=>{let s=0;switch(t){case"POSITION":case"NORMAL":s=3;break;case"COLOR":s=4;break;case"UV":case"UV1":s=2;break;case"BLENDWEIGHT":case"BLENDINDICES":case"TANGENT":s=4}let n=e.get(t);if("BLENDINDICES"!==t)for(let e=0;e<s;e++)r.push(n[e+a*s])})):d[a]&&h[a]&&(r[t+o]=g.get(a)):(h[a]=!0,g.set(a,a))}h.forEach((e,r)=>{d[r]=e||d[r]})}A.forEach((r,t)=>{let a=e.get(t);"BLENDINDICES"==t&&(a=u);let s=a.length+r.length,n=new Float32Array(s);n.set(a,0),n.set(r,a.length),e.set(t,n)}),f=null}gltfPrimitiveIndexBuffer(e){var r=this._gltf.accessors[e.indices],t=this.getAccessorBuffer(r),a=new Uint32Array(t.length);return a.set(t),t=null,a}getAccessorBuffer(r){var t=0;void 0!==r.byteOffset&&(t=r.byteOffset);var a,s,n,o=this._gltf.bufferViews[r.bufferView],i=(this._gltf.buffers[o.buffer],this.gltfBuffers[o.buffer]);switch(r.type){case e.GLTFAccessorType.SCALAR:a=1;break;case e.GLTFAccessorType.VEC2:a=2;break;case e.GLTFAccessorType.VEC3:a=3;break;case e.GLTFAccessorType.VEC4:case e.GLTFAccessorType.MAT2:a=4;break;case e.GLTFAccessorType.MAT3:a=9;break;case e.GLTFAccessorType.MAT4:a=16}switch(r.componentType){case e.GLTFComponentType.BYTE:s=r.count*a,n=new Int8Array(i,o.byteOffset+t,s);break;case e.GLTFComponentType.UNSIGNED_BYTE:s=r.count*a,n=new Uint8Array(i,o.byteOffset+t,s);break;case e.GLTFComponentType.SHORT:s=r.count*a,n=new Int16Array(i,o.byteOffset+t,s);break;case e.GLTFComponentType.UNSIGNED_SHORT:s=r.count*a,n=new Uint16Array(i,o.byteOffset+t,s);break;case e.GLTFComponentType.UNSIGNED_INT:s=r.count*a,n=new Uint32Array(i,o.byteOffset+t,s);break;case e.GLTFComponentType.FLOAT:s=r.count*a,n=new Float32Array(i,o.byteOffset+t,s)}return n}mergeOnePrimitiveArray(e,r,t){var a=new Float32Array(e),s=e/r,n=0;return t.forEach((e,t)=>{var o;switch(t){case"POSITION":case"NORMAL":o=3;break;case"COLOR":o=4;break;case"UV":case"UV1":o=2;break;case"BLENDWEIGHT":o=4;break;case"BLENDINDICES":o=1;break;case"TANGENT":o=4}for(var i=0;i<r;i++)for(var l=i*s+n,h=i*o,f=h;f<o+h;f++)a[l++]=e[f];n+=o}),a}generatMesh(e,t,a,s){var n=new r.Mesh;n.name=s;var o=new Float32Array(t),i=new Uint32Array(a),l=this.mergeSubMeshArray(e,o,i),h=r.VertexMesh.getVertexDeclaration(l,!1),f=r.LayaGL.instance,c=new r.VertexBuffer3D(4*t,f.STATIC_DRAW,!0);c.vertexDeclaration=h,c.setData(o.buffer),n._vertexCount=c._byteLength/h.vertexStride;var u=r.IndexFormat.UInt32,d=i;n._vertexCount<65536&&(u=r.IndexFormat.UInt16,d=new Uint16Array(i),i=null);var g=new r.IndexBuffer3D(u,a,f.STATIC_DRAW,!0);g.setData(d),n._indexFormat=u,n._vertexBuffer=c,n._indexBuffer=g,n._setBuffer(c,g),n._setInstanceBuffer(n._instanceBufferStateType);for(var A=e.length,p=new Array(A),m=0,v=0;v<A;v++){var y=e[v],T=new r.SubMesh(n);p[v]=T,T._vertexBuffer=c,T._indexBuffer=g;var E=m;m+=y.indexArray.length;var _=y.indexArray.length;T._setIndexRange(E,_,u),T._boneIndicesList=y.boneIndicesList,T._subIndexBufferStart=y.subIndexStartArray,T._subIndexBufferCount=y.subIndexCountArray;for(var I=0;I<T._subIndexBufferStart.length;I++)T._subIndexBufferStart[I]+=E}n._setSubMeshes(p),n.calculateBounds();var L=c._byteLength+g._byteLength;return n._setCPUMemory(L),n._setGPUMemory(L),n}mergeSubMeshArray(e,r,t){var a,s=0,n=0,o=0;return e.forEach((e,i)=>{a=e.vertexDeclarationStr,r.set(e.vertexArray,s);for(var l=0;l<e.indexArray.length;l++)e.indexArray[l]+=o;t.set(e.indexArray,n),s+=e.vertexArray.length,n+=e.indexArray.length,o+=e.vertexCount}),a}}o.maxSubBoneCount=24,o.ROOTNAME="GLTF_Root",o.GLTFIMAGETYPE="nativeimage",o.loadedMap={},o.textureMap={},o.gltfAttributeOrder=["POSITION","NORMAL","COLOR_0","TEXCOORD_0","TEXCOORD_1","WEIGHTS_0","JOINTS_0","TANGENT","JOINTS_1","WEIGHTS_1"],o.layaAttributeOrder=["POSITION","NORMAL","COLOR","UV","UV1","BLENDWEIGHT","BLENDINDICES","TANGENT","JOINTS_1","WEIGHTS_1"],e.GLTFBase64Tool=t,e.GLTFLoader=o}(window.Laya=window.Laya||{},Laya);